<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>角色設定表單</title>
  <style>
    body {
      font-family: sans-serif;
      display: flex;
      justify-content: space-between;
      padding: 20px;
    }

    form {
      flex: 1;
    }

    .attributes {
      flex: 1;
      margin-left: 40px;
      border-left: 1px solid #ccc;
      padding-left: 20px;
    }

    .attribute-group {
      margin-bottom: 10px;
    }

    input.attr-input {
      width: 40px;
      text-align: right;
      font-family: monospace;
      padding: 2px;
    }

    .remaining {
      margin-top: 20px;
      font-weight: bold;
    }

    button {
      margin-left: 5px;
    }

    label {
      display: inline-block;
      width: 80px;
    }
  </style>
</head>
<body>
  <form>
    <h3>角色資訊</h3>
    <!-- 職業 -->
    <label for="job">職業: </label>
    <select id="job" name="job">
      <option value="法師">法師</option>
      <option value="劍士 (龍騎士)">劍士 (龍騎士)</option>
      <option value="劍士 (十字軍)">劍士 (十字軍)</option>
      <option value="劍士 (騎士)">劍士 (騎士)</option>
      <option value="盜賊 (神偷)">盜賊 (神偷)</option>
      <option value="盜賊 (暗殺者)">盜賊 (暗殺者)</option>
      <option value="弓箭手">弓箭手</option>
      <option value="海盜 (槍手)">海盜 (槍手)</option>
    </select>
    <br><br>

    <!-- 等級 -->
    <label for="level">等級: </label>
    <input type="number" id="level" name="level" min="1" max="200" value="1" required>
    <br><br>

    <!-- 武器精準技能 -->
    <label for="proficiency">武器精準技能 (0~20): </label>
    <input type="number" id="proficiency" name="proficiency" min="0" max="20" value="0" required>
    <br><br>

    <!-- 可分配點數 -->
    <div>
      可分配能力值總數: <span id="points">9</span>
    </div>
  </form>

  <!-- 能力值區塊 -->
  <div class="attributes">
    <h3>能力值</h3>

    <div class="attribute-group">
      <label for="str">力量: </label>
      <input class="attr-input" type="number" id="str" min="4" value="4">
      <button type="button" onclick="changeAttr('str', -1)">-</button>
      <button type="button" onclick="changeAttr('str', 1)">+</button>
    </div>

    <div class="attribute-group">
      <label for="dex">敏捷: </label>
      <input class="attr-input" type="number" id="dex" min="4" value="4">
      <button type="button" onclick="changeAttr('dex', -1)">-</button>
      <button type="button" onclick="changeAttr('dex', 1)">+</button>
    </div>

    <div class="attribute-group">
      <label for="int">智慧: </label>
      <input class="attr-input" type="number" id="int" min="4" value="4">
      <button type="button" onclick="changeAttr('int', -1)">-</button>
      <button type="button" onclick="changeAttr('int', 1)">+</button>
    </div>

    <div class="attribute-group">
      <label for="luk">幸運: </label>
      <input class="attr-input" type="number" id="luk" min="4" value="4">
      <button type="button" onclick="changeAttr('luk', -1)">-</button>
      <button type="button" onclick="changeAttr('luk', 1)">+</button>
    </div>

    <button type="button" onclick="resetAttributes()">重置能力值</button>

    <div class="remaining">
      剩餘可用能力值點數: <span id="remaining">9</span>
    </div>
  </div>

  <script>
    const baseValue = 4;
    const attributes = ["str", "dex", "int", "luk"];

    function getLevelPoints() {
      let level = parseInt(document.getElementById("level").value) || 1;
      if (level > 200) level = 200;
      if (level < 1) level = 1;
      document.getElementById("level").value = level;
      return (level - 1) * 5 + 9;
    }

    function getTotalAllocatablePoints() {
      return getLevelPoints() + baseValue * attributes.length;
    }

    function getCurrentTotalUsedPoints() {
      return attributes.reduce((sum, attr) => {
        let val = parseInt(document.getElementById(attr).value);
        return sum + (isNaN(val) ? baseValue : val);
      }, 0);
    }

    function updatePointsDisplay() {
      const levelPoints = getLevelPoints();
      const totalPoints = getTotalAllocatablePoints();
      const used = getCurrentTotalUsedPoints();

      // 自動修正能力值輸入錯誤
      let changed = false;
      attributes.forEach(attr => {
        const input = document.getElementById(attr);
        let val = parseInt(input.value);
        if (isNaN(val) || val < baseValue) {
          input.value = baseValue;
          changed = true;
        }
      });

      const overflow = used - totalPoints;
      if (overflow > 0) {
        // 把多出來的點數自動扣除
        for (let attr of attributes) {
          let input = document.getElementById(attr);
          let val = parseInt(input.value);
          const canReduce = val - baseValue;
          const reduceBy = Math.min(canReduce, overflow);
          if (reduceBy > 0) {
            input.value = val - reduceBy;
            break;
          }
        }
      }

      document.getElementById("points").textContent = levelPoints;
      document.getElementById("remaining").textContent = getTotalAllocatablePoints() - getCurrentTotalUsedPoints();
    }

    function changeAttr(attr, delta) {
      const input = document.getElementById(attr);
      let value = parseInt(input.value);
      if (isNaN(value)) value = baseValue;

      let newValue = value + delta;

      const total = getTotalAllocatablePoints();
      const used = getCurrentTotalUsedPoints();

      if (delta > 0 && used < total) {
        input.value = newValue;
      } else if (delta < 0 && newValue >= baseValue) {
        input.value = newValue;
      }

      updatePointsDisplay();
    }

    function resetAttributes() {
      attributes.forEach(attr => {
        document.getElementById(attr).value = baseValue;
      });
      updatePointsDisplay();
    }

    // 等級、精準技能輸入修正
    function correctBoundedInput(id, min, max) {
      const input = document.getElementById(id);
      let val = parseInt(input.value);
      if (isNaN(val)) val = min;
      if (val < min) val = min;
      if (val > max) val = max;
      input.value = val;
    }

    document.getElementById("level").addEventListener("input", () => {
      correctBoundedInput("level", 1, 200);
      resetAttributes(); // 等級變動時重設能力值
      updatePointsDisplay();
    });

    document.getElementById("proficiency").addEventListener("input", () => {
      correctBoundedInput("proficiency", 0, 20);
    });

    attributes.forEach(attr => {
      document.getElementById(attr).addEventListener("input", () => {
        updatePointsDisplay();
      });
    });

    window.addEventListener("DOMContentLoaded", updatePointsDisplay);
  </script>
</body>
</html>
