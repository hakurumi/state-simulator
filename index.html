<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8" />
    <title>artale 能力值模擬器</title>
    <style>
        body {
            font-family: sans-serif;
            display: flex;
            justify-content: space-between;
            padding: 20px;
        }

        form {
            flex: 1;
        }

        .attributes {
            flex: 1;
            margin-left: 40px;
            border-left: 1px solid #ccc;
            padding-left: 20px;
        }

        .attribute-group {
            margin-bottom: 10px;
        }

        input.attr-input {
            width: 40px;
            text-align: right;
            font-family: monospace;
            padding: 2px;
        }

        input.attr-input::-webkit-outer-spin-button,
        input.attr-input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        input.attr-input[type=number] {
            -moz-appearance: textfield;
        }

        #level,
        #proficiency {
            font-family: monospace;
            width: 40px;
            text-align: right;
        }

        .remaining {
            margin-top: 20px;
            font-weight: bold;
        }

        button {
            margin-left: 5px;
        }

        label {
            display: inline-block;
            width: 80px;
        }

        .extra-attributes {
            margin-top: 30px;
        }

        .extra-attributes h4 {
            margin-bottom: 10px;
        }
    </style>
</head>

<body>
    <form>
        <h3>角色資訊</h3>
        <label for="job">職業: </label>
        <select id="job" name="job">
            <option value="劍士 (龍騎士)">劍士 (龍騎士)</option>
            <option value="劍士 (十字軍)">劍士 (十字軍)</option>
            <option value="劍士 (騎士)">劍士 (騎士)</option>
            <option value="盜賊 (神偷)">盜賊 (神偷)</option>
            <option value="盜賊 (暗殺者)">盜賊 (暗殺者)</option>
            <option value="弓箭手 (遊俠)">弓箭手 (遊俠)</option>
            <option value="弓箭手 (狙擊手)">弓箭手 (狙擊手)</option>
            <option value="法師">法師</option>
            <option value="海盜 (槍手)">海盜 (槍手)</option>
        </select><br /><br />

        <label for="level">等級: </label>
        <input type="text" id="level" name="level" value="1" required /><br />

        <div>(可分配能力值點數: <span id="points">9</span>)</div><br />

        <div id="proficiency-group">
            <label for="proficiency">精準武器: </label>
            <input type="text" id="proficiency" name="proficiency" value="0" required />
            <select id="weapon-type-select" style="display:none; margin-left:8px; width:70px;"></select>
            <br /><br />
        </div>
        <div id="attack-display"></div>
    </form>

    <div class="attributes">
        <h3>能力值</h3>
        <div class="attribute-group">
            <label for="str">力量: </label>
            <span id="total-str" class="total-display"></span>
            <span> ( </span>
            <input class="attr-input" type="number" id="str" min="4" value="4" />
            <span> + </span>
            <input class="attr-input" type="number" id="extra-str" value="0" />
            <span> ) </span>
            <button type="button" onclick="changeAttr('str', -1)">-</button>
            <button type="button" onclick="changeAttr('str', 1)">+</button>
        </div>
        <div class="attribute-group">
            <label for="dex">敏捷: </label>
            <span id="total-dex" class="total-display"></span>
            <span> ( </span>
            <input class="attr-input" type="number" id="dex" min="4" value="4" />
            <span> + </span>
            <input class="attr-input" type="number" id="extra-dex" value="0" />
            <span> ) </span>
            <button type="button" onclick="changeAttr('dex', -1)">-</button>
            <button type="button" onclick="changeAttr('dex', 1)">+</button>
        </div>
        <div class="attribute-group">
            <label for="int">智慧: </label>
            <span id="total-int" class="total-display"></span>
            <span> ( </span>
            <input class="attr-input" type="number" id="int" min="4" value="4" />
            <span> + </span>
            <input class="attr-input" type="number" id="extra-int" value="0" />
            <span> ) </span>
            <button type="button" onclick="changeAttr('int', -1)">-</button>
            <button type="button" onclick="changeAttr('int', 1)">+</button>
        </div>
        <div class="attribute-group">
            <label for="luk">幸運: </label>
            <span id="total-luk" class="total-display"></span>
            <span> ( </span>
            <input class="attr-input" type="number" id="luk" min="4" value="4" />
            <span> + </span>
            <input class="attr-input" type="number" id="extra-luk" value="0" />
            <span> ) </span>
            <button type="button" onclick="changeAttr('luk', -1)">-</button>
            <button type="button" onclick="changeAttr('luk', 1)">+</button>
        </div>

        <button type="button" onclick="resetAttributes()">重置能力值</button>

        <div class="remaining">
            剩餘可用能力值點數: <span id="remaining">9</span>
        </div>
    </div>

    <script>
        const baseValue = 4;
        const attributes = ["str", "dex", "int", "luk"];
        const extraAttributes = ["extra-str", "extra-dex", "extra-int", "extra-luk"];

        function getLevelPoints() {
            let level = parseInt(document.getElementById("level").value.trim()) || 1;
            level = Math.max(1, Math.min(level, 200));
            document.getElementById("level").value = level;
            return (level - 1) * 5 + 9;
        }

        function getTotalAllocatablePoints() {
            return getLevelPoints() + baseValue * attributes.length;
        }

        function getCurrentTotalUsedPoints() {
            return attributes.reduce((sum, attr) => {
                let val = parseInt(document.getElementById(attr).value);
                return sum + (isNaN(val) ? baseValue : val);
            }, 0);
        }

        function updatePointsDisplay() {
            const levelPoints = getLevelPoints();
            const totalPoints = getTotalAllocatablePoints();
            const used = getCurrentTotalUsedPoints();

            attributes.forEach((attr) => {
                const input = document.getElementById(attr);
                let val = parseInt(input.value);
                if (isNaN(val) || val < baseValue) {
                    input.value = baseValue;
                }
            });

            const overflow = used - totalPoints;
            if (overflow > 0) {
                for (let attr of attributes) {
                    let input = document.getElementById(attr);
                    let val = parseInt(input.value);
                    const canReduce = val - baseValue;
                    const reduceBy = Math.min(canReduce, overflow);
                    if (reduceBy > 0) {
                        input.value = val - reduceBy;
                        break;
                    }
                }
            }

            document.getElementById("points").textContent = levelPoints;
            document.getElementById("remaining").textContent = totalPoints - getCurrentTotalUsedPoints();
        }

        function changeAttr(attr, delta) {
            const input = document.getElementById(attr);
            let value = parseInt(input.value);
            if (isNaN(value)) value = baseValue;

            let newValue = value + delta;
            const total = getTotalAllocatablePoints();
            const used = getCurrentTotalUsedPoints();

            if (delta > 0 && used < total) {
                input.value = newValue;
            } else if (delta < 0 && newValue >= baseValue) {
                input.value = newValue;
            }

            updatePointsDisplay();
            updateTotalAttributeDisplays();
        }

        function resetAttributes() {
            attributes.forEach((attr) => {
                document.getElementById(attr).value = baseValue;
            });
            extraAttributes.forEach((id) => {
                document.getElementById(id).value = 0;
            });
            updatePointsDisplay();
            updateTotalAttributeDisplays();
        }

        function correctBoundedInputText(id, min, max, width) {
            const input = document.getElementById(id);
            let val = parseInt(input.value.trim());
            if (isNaN(val)) val = min;
            if (val < min) val = min;
            if (val > max) val = max;
            input.value = val;
        }

        function correctExtraAttributes() {
            extraAttributes.forEach((id) => {
                const input = document.getElementById(id);
                let val = parseInt(input.value.trim());
                if (isNaN(val)) val = 0;
                if (val < 0) val = 0;
                if (val > 999) val = 999;
                input.value = val;
            });
        }

        function updateAttackDisplay() {
            const job = document.getElementById("job").value;
            const display = document.getElementById("attack-display");

            if (job === "法師") {
                const matk = 123; // 可以改為根據 int 計算
                display.textContent = `魔法攻擊力 ${matk.toString().padStart(4, " ")}`;
            } else {
                const minAtk = 45;
                const maxAtk = 89;
                display.textContent = `攻擊力 ${minAtk.toString().padStart(4, " ")} ~ ${maxAtk.toString().padStart(4, " ")}`;
            }
        }

        function updateTotalAttributeDisplays() {
            attributes.forEach((attr) => {
                const base = parseInt(document.getElementById(attr).value) || 0;
                const extra = parseInt(document.getElementById(`extra-${attr}`).value) || 0;
                const total = base + extra;
                const display = document.getElementById(`total-${attr}`);
                display.textContent = `${total}`;
            });
        }

        function updateProficiencyVisibility() {
            const job = document.getElementById("job").value;
            const profGroup = document.getElementById("proficiency-group");
            if (job === "法師") {
                profGroup.style.display = "none";
            } else {
                profGroup.style.display = "block";
            }
        }

        function updateWeaponTypeSelect() {
            const job = document.getElementById("job").value;
            const select = document.getElementById("weapon-type-select");

            // 劍士分支對應武器選項
            const optionsMap = {
                "劍士 (龍騎士)": ["槍武器", "矛武器"],
                "劍士 (十字軍)": ["單手劍", "雙手劍", "單手斧", "雙手斧"],
                "劍士 (騎士)": ["單手劍", "雙手劍", "單手棍", "雙手棍"]
            };

            if (job in optionsMap) {
                // 清空並生成選項
                select.innerHTML = "";
                optionsMap[job].forEach((opt) => {
                    const option = document.createElement("option");
                    option.value = opt;
                    option.textContent = opt;
                    select.appendChild(option);
                });
                select.style.display = "inline-block";
            } else {
                select.style.display = "none";
                select.innerHTML = "";
            }
        }

        document.getElementById("level").addEventListener("input", () => {
            correctBoundedInputText("level", 1, 200, 3);
            resetAttributes();
            updatePointsDisplay();
            updateAttackDisplay();
            updateTotalAttributeDisplays();
        });

        document.getElementById("proficiency").addEventListener("input", () => {
            correctBoundedInputText("proficiency", 0, 20, 2);
        });

        document.getElementById("job").addEventListener("change", () => {
            updateProficiencyVisibility();
            updateAttackDisplay();
            updateWeaponTypeSelect();
        });

        attributes.forEach((attr) => {
            document.getElementById(attr).addEventListener("input", () => {
                updatePointsDisplay();
                updateAttackDisplay();
                updateTotalAttributeDisplays();
            });
        });

        extraAttributes.forEach((id) => {
            document.getElementById(id).addEventListener("input", () => {
                correctExtraAttributes();
                updateTotalAttributeDisplays();
            });
        });

        window.addEventListener("DOMContentLoaded", () => {
            updatePointsDisplay();
            correctExtraAttributes();
            updateAttackDisplay();
            updateTotalAttributeDisplays();
            updateProficiencyVisibility();
            updateWeaponTypeSelect();
        });
    </script>
</body>

</html>